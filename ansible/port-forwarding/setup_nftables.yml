- hosts: all
  become: true
  tasks:
    - name: Enable net.ipv4.ip_forward
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        sysctl_set: true
        state: present
        reload: true
    - name: Disable ufw
      shell: ufw disable
    - name: Disable ufw service
      ansible.builtin.systemd_service:
        name: ufw
        enabled: false
        masked: yes
    - name: Install nftables
      ansible.builtin.apt:
        name: nftables
    - name: Enable nftables service
      ansible.builtin.systemd_service:
        name: nftables
        enabled: true
        masked: no
    - name: Flush rules
      shell: nft flush ruleset
    - name: Save rules
      shell: nft list ruleset | tee /etc/nftables.conf
    - name: Restart machine
      ansible.builtin.reboot:
    - name: Add nat table
      shell: nft add table nat
    - name: Add postrouting chain
      shell: nft 'add chain nat postrouting { type nat hook postrouting priority 100 ; }'
    - name: Add prerouting chain
      shell: nft 'add chain nat prerouting { type nat hook prerouting priority -100; }'
    - name: Add masquerade rule
      shell: nft add rule nat postrouting masquerade
    - name: Save rules
      shell: nft list ruleset | tee /etc/nftables.conf

- hosts: public
  become: true
  roles:
    - role: forward_tcp
      self_address: "{{ ansible_host }}"
      forward_port: 25565 # Change
      target_server: "{{ hostvars[groups['private'][0]]['tailscale_address'] }}"

- hosts: private
  become: true
  roles:
    - role: forward_tcp
      self_address: "{{ tailscale_address }}"
      forward_port: 25565 # Change
      target_server: "192.168.0.146" # Change

#- hosts: public
#  become: true
#  roles:
#    - role: forward_tcp
#      in_interface: eth0
#      out_interface: tailscale0
#      forward_port: 25565
#      self_address: "{{ tailscale_address }}"
#      target_server: "{{ hostvars[groups['private'][0]]['tailscale_address'] }}"
#      target_server: "100.110.156.109"

#- hosts: private
#  become: true
#  roles:
#    - role: forward_tcp
#      in_interface: tailscale0
#      out_interface: eth0
#      forward_port: 25565
#      self_address: "{{ tailscale_address }}"
#      target_server: "192.168.0.146"